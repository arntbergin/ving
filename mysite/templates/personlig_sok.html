{% extends "base.html" %}

{% block content %}

<div class="mb-3 sÃ¸k-boks"> 
<h2 class="mb-3">
    Legg til personlig sÃ¸k
    <a href="https://www.ving.no/bestill-reise?CategoryId=2&QueryAreaID=0&QueryCtryID=4328&QueryDepDate=20260428&QueryDepID=12672&QueryDur=8&QueryResID=4345&QueryRoomAges=%7C42&QueryUnits=1&experiments=test%3Ab%2Cuniversalhotelcard%3Aold%2Cnamecollectionpopup%3Aold%2Ccharterflowhotelcard%3Aabovefold&firstDisplayed=-1&nrOfHotels=10&selectedTransport=flight%7CCgJWThIkMjljNzMyZDItMTAzYi00MDc1LWJiOTctYjVkYjk2OWZjYmVi" 
       class="btn btn-secondary" target="_blank">
        Eksempel
    </a>
</h2>

<form id="lagre-form" method="post" class="mb-4" action="{% url 'personlig_sok' %}">
    {% csrf_token %}
    <input type="text" name="navn" id="navn-input" class="form-control" placeholder="Navn pÃ¥ sÃ¸ket" required>
    <input type="url" name="url" id="url-input" class="form-control" placeholder="Lim inn URL her" required>
    <div class="mb-3"></div>
    <button type="button" class="btn btn-info" id="lagre-knapp">Lagre</button>
</form>

<!-- Popup (Bootstrap modal) -->
<div class="modal fade" id="testModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Status</h5>
      </div>
      <div class="modal-body" id="testModalBody">
        ðŸ”„ Tester URL...
      </div>
    </div>
  </div>
</div>

<h3>Dine lagrede URL-er</h3>
{% if mine_urler %}
    <ul class="list-group">
        {% for item in mine_urler %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ item.navn }}</strong><br>
                    <small class="text-muted">Lagt til {{ item.lagt_til|date:"d.m.Y H:i" }}</small>
                </div>
                <form method="post" action="{% url 'slett_personlig_url' item.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Slett</button>
                </form>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <div class="alert alert-info mt-3">Ingen URL-er lagret ennÃ¥.</div>
{% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const lagreKnapp = document.getElementById("lagre-knapp");
  const urlInput = document.getElementById("url-input");
  const navnInput = document.getElementById("navn-input");
  const form = document.getElementById("lagre-form");
  const testModal = new bootstrap.Modal(document.getElementById('testModal'));
  const testModalBody = document.getElementById('testModalBody');

  lagreKnapp.addEventListener("click", () => {
    const url = urlInput.value;
    const navn = navnInput.value;

    if (!url || !navn) {
      testModalBody.textContent = "âŒ Du mÃ¥ fylle inn bÃ¥de navn og URL";
      testModal.show();
      setTimeout(() => testModal.hide(), 2000);
      return;
    }

    testModalBody.textContent = "ðŸ”„ Tester URL - tar opptil 15 sekunder...";
    testModal.show();

    fetch(`/test-ving-url/?url=${encodeURIComponent(url)}`)
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          testModalBody.textContent = "âœ… Test ok â€“ lagrer - tar opptil 15 sekunder...";
          fetch(form.action, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `navn=${encodeURIComponent(navn)}&url=${encodeURIComponent(url)}`
          })
          .then(res => {
            if (res.ok) {
              testModalBody.textContent = "âœ… Lagret!";
              setTimeout(() => {
                testModal.hide();          // lukk modal
                window.location.reload();  // reload siden
              }, 1000);
            } else {
              testModalBody.textContent = "âŒ Feil ved lagring";
              setTimeout(() => testModal.hide(), 2500);
            }
          });
        } else {
          testModalBody.textContent = `âŒ ${data.error || data.message}`;
          setTimeout(() => testModal.hide(), 2500);
        }
      })
      .catch(() => {
        testModalBody.textContent = "âŒ Feil ved testing";
        setTimeout(() => testModal.hide(), 2500);
      });
  });
});
</script>

{% endblock %}
        